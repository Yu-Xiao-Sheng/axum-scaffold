# Generated Project API Contract

**Version**: 1.0.0
**Last Updated**: 2025-02-05
**Purpose**: Define the HTTP API surface of projects generated by axum-app-create

## Overview

Projects generated by axum-app-create expose a RESTful HTTP API built with Axum. This contract defines the standard endpoints, request/response formats, error handling, and authentication mechanisms.

## Base URL

```
http://127.0.0.1:8080
```

Configurable via environment variables:
- `HOST`: Default `127.0.0.1`
- `PORT`: Default `8080`

## Common Headers

### Request Headers

| Header | Required | Description | Example |
|--------|----------|-------------|---------|
| `Content-Type` | Yes* | Media type of request body | `application/json` |
| `Authorization` | Yes† | Bearer token (auth required) | `Bearer <token>` |

*Required for POST/PUT/PATCH requests
†Required for protected endpoints

### Response Headers

| Header | Description | Example |
|--------|-------------|---------|
| `Content-Type` | Media type of response body | `application/json` |
| `Content-Length` | Response body length | `123` |

## Standard Endpoints

### Health Check

Always available, regardless of optional features.

#### GET /health

Check server health status.

**Request**:
```http
GET /health HTTP/1.1
Host: 127.0.0.1:8080
```

**Response (200 OK)**:
```json
{
  "status": "ok",
  "timestamp": "2025-02-05T10:30:00Z"
}
```

**Response (503 Service Unavailable)**:
```json
{
  "status": "degraded",
  "timestamp": "2025-02-05T10:30:00Z",
  "issues": ["database: connection timeout"]
}
```

### Root Endpoint

#### GET /

Returns basic server information.

**Request**:
```http
GET / HTTP/1.1
Host: 127.0.0.1:8080
```

**Response (200 OK)**:
```json
{
  "name": "my-axum-app",
  "version": "0.1.0",
  "description": "An Axum web application"
}
```

## Authentication Endpoints

Available when `--auth` flag is used during project generation.

### POST /auth/register

Register a new user account.

**Request**:
```http
POST /auth/register HTTP/1.1
Host: 127.0.0.1:8080
Content-Type: application/json

{
  "username": "johndoe",
  "email": "john@example.com",
  "password": "SecurePass123!"
}
```

**Request Fields**:

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| `username` | string | Yes | 3-30 chars, alphanumeric + `_` | Unique username |
| `email` | string | Yes | Valid email format | Unique email address |
| `password` | string | Yes | Min 8 chars | Plain text password (will be hashed) |

**Response (201 Created)**:
```json
{
  "id": 1,
  "username": "johndoe",
  "email": "john@example.com",
  "created_at": "2025-02-05T10:30:00Z"
}
```

**Response (400 Bad Request)** - Validation Error:
```json
{
  "code": 1001,
  "msg": "Validation failed",
  "data": {
    "field": "username",
    "reason": "Username must be at least 3 characters"
  }
}
```

**Response (409 Conflict)** - User Exists:
```json
{
  "code": 1002,
  "msg": "Username already exists",
  "data": {
    "field": "username",
    "value": "johndoe"
  }
}
```

### POST /auth/login

Authenticate and receive JWT token.

**Request**:
```http
POST /auth/login HTTP/1.1
Host: 127.0.0.1:8080
Content-Type: application/json

{
  "username": "johndoe",
  "password": "SecurePass123!"
}
```

**Request Fields**:

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `username` | string | Yes | Username or email |
| `password` | string | Yes | User password |

**Response (200 OK)**:
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "Bearer",
  "expires_in": 86400
}
```

**Response Fields**:

| Field | Type | Description |
|-------|------|-------------|
| `access_token` | string | JWT access token |
| `token_type` | string | Token type (always "Bearer") |
| `expires_in` | number | Token lifetime in seconds (default: 86400 = 24 hours) |

**Response (401 Unauthorized)** - Invalid Credentials:
```json
{
  "code": 3002,
  "msg": "Invalid username or password"
}
```

**Response (404 Not Found)** - User Not Found:
```json
{
  "code": 2002,
  "msg": "User not found"
}
```

### POST /auth/logout

Invalidate JWT token (optional, stateless).

**Note**: Since JWT is stateless, logout is typically handled client-side by deleting the token. This endpoint is included for future token blacklist implementation.

**Request**:
```http
POST /auth/logout HTTP/1.1
Host: 127.0.0.1:8080
Authorization: Bearer <token>
```

**Response (200 OK)**:
```json
{
  "message": "Logged out successfully"
}
```

**Response (401 Unauthorized)** - Invalid Token:
```json
{
  "code": 3001,
  "msg": "Unauthorized access"
}
```

## Protected Endpoints

These endpoints require valid JWT authentication.

### GET /api/user/profile

Get current user profile.

**Request**:
```http
GET /api/user/profile HTTP/1.1
Host: 127.0.0.1:8080
Authorization: Bearer <token>
```

**Response (200 OK)**:
```json
{
  "id": 1,
  "username": "johndoe",
  "email": "john@example.com",
  "created_at": "2025-02-05T10:30:00Z"
}
```

**Response (401 Unauthorized)** - Invalid/Missing Token:
```json
{
  "code": 3001,
  "msg": "Unauthorized access"
}
```

**Response (404 Not Found)** - User Deleted:
```json
{
  "code": 2002,
  "msg": "User not found"
}
```

### PUT /api/user/profile

Update current user profile.

**Request**:
```http
PUT /api/user/profile HTTP/1.1
Host: 127.0.0.1:8080
Authorization: Bearer <token>
Content-Type: application/json

{
  "email": "newemail@example.com"
}
```

**Request Fields**:

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `email` | string | No | New email address (must be unique) |

**Response (200 OK)**:
```json
{
  "id": 1,
  "username": "johndoe",
  "email": "newemail@example.com",
  "created_at": "2025-02-05T10:30:00Z",
  "updated_at": "2025-02-05T11:00:00Z"
}
```

**Response (400 Bad Request)** - Validation Error:
```json
{
  "code": 1001,
  "msg": "Validation failed",
  "data": {
    "field": "email",
    "reason": "Invalid email format"
  }
}
```

**Response (401 Unauthorized)**:
```json
{
  "code": 3001,
  "msg": "Unauthorized access"
}
```

## Example Endpoints

### GET /api/examples/hello

Simple hello world endpoint.

**Request**:
```http
GET /api/examples/hello HTTP/1.1
Host: 127.0.0.1:8080
```

**Response (200 OK)**:
```json
{
  "message": "Hello, World!"
}
```

### GET /api/examples/hello/{name}

Greet a specific person.

**Request**:
```http
GET /api/examples/hello/Alice HTTP/1.1
Host: 127.0.0.1:8080
```

**Response (200 OK)**:
```json
{
  "message": "Hello, Alice!"
}
```

**Response (400 Bad Request)** - Invalid Name:
```json
{
  "code": 1002,
  "msg": "Invalid input data",
  "data": {
    "field": "name",
    "reason": "Name must contain only alphabetic characters"
  }
}
```

## Error Response Format

All errors follow a consistent format (when `--biz-error` flag is used).

### Standard Error Response

```json
{
  "code": 1001,
  "msg": "Validation failed",
  "data": {
    "field": "username",
    "reason": "Username is required"
  }
}
```

**Fields**:

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `code` | number | Yes | Numeric error code (see Error Codes) |
| `msg` | string | Yes | Human-readable error message (localized) |
| `data` | object | No | Additional error context |

### Error Codes

| Code | Status | Name | Description |
|------|--------|------|-------------|
| 1001 | 400 | VALIDATION_ERROR | Generic validation error |
| 1002 | 400 | INVALID_INPUT | Invalid input data |
| 1003 | 400 | MISSING_REQUIRED_FIELD | Missing required field |
| 2001 | 404 | RESOURCE_NOT_FOUND | Generic resource not found |
| 2002 | 404 | USER_NOT_FOUND | User not found |
| 3001 | 401 | UNAUTHORIZED | Unauthorized access |
| 3002 | 401 | INVALID_CREDENTIALS | Invalid username/password |
| 3003 | 403 | FORBIDDEN | Access forbidden |
| 5001 | 500 | DATABASE_ERROR | Database operation failed |
| 5002 | 500 | CONNECTION_ERROR | Database connection failed |
| 9000 | 500 | INTERNAL_ERROR | Internal server error |

### HTTP Status Codes

| Status | Meaning |
|--------|---------|
| 200 OK | Request succeeded |
| 201 Created | Resource created |
| 400 Bad Request | Invalid request data |
| 401 Unauthorized | Authentication required/failed |
| 403 Forbidden | Insufficient permissions |
| 404 Not Found | Resource not found |
| 409 Conflict | Resource conflict (e.g., duplicate) |
| 500 Internal Server Error | Server error |
| 503 Service Unavailable | Service temporarily unavailable |

## Authentication

### JWT Token Format

Tokens use JWT (JSON Web Token) format with HS256 signing.

**Header**:
```json
{
  "alg": "HS256",
  "typ": "JWT"
}
```

**Payload**:
```json
{
  "sub": 1,
  "username": "johndoe",
  "exp": 1707139200,
  "iat": 1707052800
}
```

**Fields**:

| Field | Type | Description |
|-------|------|-------------|
| `sub` | number | User ID (subject) |
| `username` | string | Username |
| `exp` | number | Token expiration time (Unix timestamp) |
| `iat` | number | Token issued at (Unix timestamp) |

### Token Usage

Include token in Authorization header:

```http
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### Token Validation

Tokens are validated on each request to protected endpoints:

1. Signature verification using `JWT_SECRET`
2. Expiration check
3. User existence check (optional)

## Internationalization

Error messages support multiple languages (English and Chinese by default).

### Language Detection

Language is determined from:
1. `Accept-Language` header
2. `LANG` environment variable
3. Default: English

**Example**:
```http
GET /api/user/profile HTTP/1.1
Host: 127.0.0.1:8080
Accept-Language: zh-CN
Authorization: Bearer <token>
```

**Response (404)**:
```json
{
  "code": 2002,
  "msg": "用户未找到"
}
```

## Pagination

Future endpoints may support pagination. Standard format:

**Request**:
```http
GET /api/resources?page=1&per_page=10 HTTP/1.1
```

**Response**:
```json
{
  "data": [...],
  "pagination": {
    "page": 1,
    "per_page": 10,
    "total": 100,
    "total_pages": 10
  }
}
```

## Rate Limiting

Not included in Phase 1 MVP. Planned for future releases.

## CORS

CORS is enabled by default for development. Configure in production:

```rust
// In generated src/main.rs
let cors = CorsLayer::new()
    .allow_origin(Any.or_specific("https://example.com".parse::<HeaderValue>().unwrap()))
    .allow_methods([Method::GET, Method::POST])
    .allow_headers(Any);
```

## WebSocket Support

Not included in Phase 1 MVP. Planned for future releases.

## Testing

### Manual Testing

```bash
# Health check
curl http://127.0.0.1:8080/health

# Register user
curl -X POST http://127.0.0.1:8080/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","email":"test@example.com","password":"Pass123!"}'

# Login
curl -X POST http://127.0.0.1:8080/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"Pass123!"}'

# Save token
TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

# Get profile
curl http://127.0.0.1:8080/api/user/profile \
  -H "Authorization: Bearer $TOKEN"
```

### Integration Testing

Generated projects include integration tests:

```rust
#[tokio::test]
async fn test_health_endpoint() {
    let app = create_app();
    let response = app
        .oneshot(Request::builder()
            .uri("/health")
            .body(Body::empty())
            .unwrap())
        .await
        .unwrap();

    assert_eq!(response.status(), StatusCode::OK);
}
```

Run tests:
```bash
cargo test
```

## OpenAPI/Swagger

Not included in Phase 1 MVP. Planned for future releases with `utoipa` crate.

## Versioning

API versioning via URL path (future):
- `/v1/` - Current version
- `/v2/` - Future breaking changes

Phase 1 uses no version prefix (root API).

## References

- **Axum Documentation**: https://docs.rs/axum/
- **JWT (jsonwebtoken)**: https://docs.rs/jsonwebtoken/
- **biz-error**: https://docs.rs/biz-error/

---

**Document Version**: 1.0.0
**Last Updated**: 2025-02-05
**Maintainer**: axum-app-create team
